{"version":3,"sources":["../src/shared_promise.ts","../src/rpc_client.ts"],"sourcesContent":["export class AquiverPromise<T> {\r\n\r\n    resolve!: (value: T | PromiseLike<T>) => void;\r\n    reject!: (reason?: any) => void;\r\n    promise!: Promise<T>;\r\n\r\n    constructor() {\r\n        this.promise = new Promise<T>((resolve, reject) => {\r\n            this.resolve = resolve;\r\n            this.reject = reject;\r\n        });\r\n    }\r\n}\r\n\r\nexport interface EventInfo {\r\n    env: \"browser\" | \"client\" | \"server\";\r\n}","import { AquiverPromise, EventInfo } from \"./shared_promise\";\r\n\r\ntype RemoteCallback = (args: any, info: ClientEventInfo) => any;\r\ntype EventCallback = (args: any, info: ClientEventInfo) => void;\r\n\r\ninterface ClientEventInfo extends EventInfo {\r\n\r\n}\r\n\r\nnew class ClientRPC {\r\n\r\n    #pendings: Record<number, AquiverPromise<any>> = {}\r\n    #rpcListeners: Record<string, RemoteCallback> = {}\r\n    #events: Record<string, Set<EventCallback>> = {}\r\n\r\n    #idCounter: number = 1;\r\n\r\n    constructor() {\r\n        RegisterNuiCallbackType(\"BROWSER_TO_SERVER\");\r\n        onNet(\"__cfx_nui:BROWSER_TO_SERVER\", ({ eventName, args }, cb) => {\r\n            this.#__triggerServer__(eventName, args, {\r\n                env: \"browser\"\r\n            });\r\n\r\n            cb({});\r\n        });\r\n\r\n        RegisterNuiCallbackType(\"BROWSER_CALL_SERVER\");\r\n        onNet(\"__cfx_nui:BROWSER_CALL_SERVER\", ({ eventName, args }, cb) => {\r\n            this.#__callServer__(eventName, args, { env: \"browser\" }).then(res => {\r\n                cb(res);\r\n            });\r\n        });\r\n\r\n        RegisterNuiCallbackType(\"BROWSER_CALL_CLIENT\");\r\n        onNet(\"__cfx_nui:BROWSER_CALL_CLIENT\", ({ eventName, args }, cb) => {\r\n            this.#__call__(eventName, args, { env: \"browser\" }).then(res => {\r\n                cb(res);\r\n            });\r\n        });\r\n\r\n        RegisterNuiCallbackType(\"BROWSER_TO_CLIENT\");\r\n        onNet(\"__cfx_nui:BROWSER_TO_CLIENT\", ({ eventName, args }, cb) => {\r\n            this.#__trigger__(eventName, args, { env: \"browser\" });\r\n\r\n            cb({});\r\n        });\r\n\r\n        onNet(\"rpc:CALL_SERVER_RESOLVE\", ({ id, response }) => {\r\n            const pendingPromise = this.#pendings[id];\r\n            if (pendingPromise instanceof AquiverPromise) {\r\n                pendingPromise.resolve(response);\r\n            }\r\n\r\n            if (this.#pendings[id]) {\r\n                delete this.#pendings[id];\r\n            }\r\n        });\r\n\r\n        onNet(\"rpc:CALL_CLIENT\", ({ eventName, args, id }) => {\r\n            this.#__call__(eventName, args, { env: \"server\" }).then(response => {\r\n                emitNet(\"rpc:CALL_CLIENT_RESOLVE\", { response, id });\r\n            });\r\n        });\r\n\r\n        onNet(\"rpc:TRIGGER_CLIENT\", ({ eventName, args }) => {\r\n            this.#__trigger__(eventName, args, { env: \"server\" });\r\n        });\r\n\r\n        const methods = Object.getOwnPropertyNames(Object.getPrototypeOf(this));\r\n        methods.forEach(methodName => {\r\n            if (methodName.startsWith(\"constructor\")) return;\r\n\r\n            globalThis.exports(methodName, this[methodName].bind(this));\r\n        });\r\n    }\r\n\r\n    #getGlobalNamePrefix() {\r\n        return GetInvokingResource() || GetCurrentResourceName();\r\n    }\r\n\r\n    /** Backend function for triggerserver. Do not use if you dunno what you are doing. */\r\n    #__triggerServer__(eventName: string, args: any, ev: ClientEventInfo) {\r\n        emitNet(\"rpc:TRIGGER_SERVER\", { eventName, args, ev });\r\n    }\r\n\r\n    public triggerGlobalServer(eventName: string, args?: any) {\r\n        this.#__triggerServer__(eventName + this.#getGlobalNamePrefix(), args, { env: \"client\" });\r\n    }\r\n\r\n    /** Trigger a server event from clientside. (Client->Server) */\r\n    public triggerServer(eventName: string, args?: any) {\r\n        this.#__triggerServer__(eventName, args, { env: \"client\" });\r\n    }\r\n\r\n    #__callServer__(eventName: string, args: any, ev: ClientEventInfo) {\r\n        const id = this.#generateId();\r\n\r\n        this.#pendings[id] = new AquiverPromise();\r\n\r\n        emitNet(\"rpc:CALL_SERVER\", { eventName, args, id, ev });\r\n\r\n        return this.#pendings[id].promise;\r\n    }\r\n\r\n    public callGlobalServer(eventName: string, args?: any) {\r\n        return this.#__callServer__(eventName + this.#getGlobalNamePrefix(), args, { env: \"client\" });\r\n    }\r\n\r\n    public callServer(eventName: string, args?: any) {\r\n        return this.#__callServer__(eventName, args, { env: \"client\" });\r\n    }\r\n\r\n    #__on__(eventName: string, cb: EventCallback) {\r\n        if (!this.#events[eventName]) {\r\n            this.#events[eventName] = new Set();\r\n        }\r\n\r\n        this.#events[eventName].add(cb);\r\n\r\n        return () => this.#__off__(eventName, cb);\r\n    }\r\n\r\n    #__off__(eventName: string, cb: EventCallback) {\r\n        if (!this.#events[eventName]) return false;\r\n\r\n        this.#events[eventName].delete(cb);\r\n\r\n        return true;\r\n    }\r\n\r\n    public onGlobal(eventName: string, cb: EventCallback) {\r\n        return this.#__on__(eventName + this.#getGlobalNamePrefix(), cb);\r\n    }\r\n\r\n    public on(eventName: string, cb: EventCallback) {\r\n        return this.#__on__(eventName, cb);\r\n    }\r\n\r\n    public triggerGlobal(eventName: string, args?: any) {\r\n        this.#__trigger__(eventName + this.#getGlobalNamePrefix(), args, { env: \"client\" });\r\n    }\r\n\r\n    public trigger(eventName: string, args?: any) {\r\n        this.#__trigger__(eventName, args, { env: \"client\" });\r\n    }\r\n\r\n    /** Backend function for triggering an event locally. Do not use if you dunno what you are doing. */\r\n    #__trigger__(eventName: string, args: any, ev: ClientEventInfo) {\r\n        const registeredEvents = this.#events[eventName];\r\n        if (!registeredEvents) return;\r\n\r\n        registeredEvents.forEach(a => {\r\n            a(args, ev);\r\n        });\r\n    }\r\n\r\n    #__register__(eventName: string, cb: RemoteCallback) {\r\n        if (typeof eventName !== \"string\" || typeof cb !== \"function\") return;\r\n\r\n        console.log(`client register ${eventName}`);\r\n\r\n        this.#rpcListeners[eventName] = cb;\r\n\r\n        return () => this.unregister(eventName);\r\n    }\r\n\r\n    public registerGlobal(eventName: string, cb: RemoteCallback) {\r\n        return this.#__register__(eventName + this.#getGlobalNamePrefix(), cb);\r\n    }\r\n\r\n    /**\r\n     * Register an rpc.\r\n     * @returns the unregister function.\r\n     */\r\n    public register(eventName: string, cb: RemoteCallback) {\r\n        return this.#__register__(eventName, cb);\r\n    }\r\n\r\n    public unregister(eventName: string) {\r\n        return this.#__unregister__(eventName);\r\n    }\r\n\r\n    public unregisterGlobal(eventName: string) {\r\n        return this.#__unregister__(eventName);\r\n    }\r\n\r\n    #__unregister__(eventName: string) {\r\n        if (!this.#rpcListeners[eventName]) return false;\r\n\r\n        console.log(`unregister ${eventName}`);\r\n\r\n        delete this.#rpcListeners[eventName];\r\n\r\n        return true;\r\n    }\r\n\r\n    #__call__<T>(eventName: string, args: any, ev: ClientEventInfo): Promise<T> {\r\n        if (typeof this.#rpcListeners[eventName] !== \"function\") return Promise.reject(`Call event function does not exist: ${eventName}`);\r\n\r\n        return Promise.resolve(this.#rpcListeners[eventName](args, ev));\r\n    }\r\n\r\n    public callGlobal<T>(eventName: string, args?: any): Promise<T> {\r\n        return this.#__call__(eventName + this.#getGlobalNamePrefix(), args, { env: \"client\" });\r\n    }\r\n\r\n    public call<T>(eventName: string, args?: any): Promise<T> {\r\n        return this.#__call__(eventName, args, { env: \"client\" });\r\n    }\r\n\r\n    #generateId() {\r\n        this.#idCounter++;\r\n\r\n        return this.#idCounter;\r\n    }\r\n}"],"mappings":"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","names":[]}